<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<p id="demo"></p>

<script>
    document.getElementById("demo").innerHTML =
        "The full URL of this page is:<br>" + window.location.href;
</script>

<div style="margin: 10px">
    <p>table</p>
    <div id="status-table-container">
    </div>
</div>



<script>
    if (window.EventSource == null) {
        alert('The browser does not support Server-Sent Events');
    } else {
        var eventSource = new EventSource('/api/statussse');

        eventSource.onopen = function () {
            console.log('connection is established');
        };

        eventSource.onerror = function (error) {
            console.log('connection state: ' + eventSource.readyState + ', error: ' + event);
        };

        eventSource.onmessage = function (event) {
            console.log('data:' + event.data);
            let eventdatasjsonstringStartAt = event.data.indexOf('{');
            let eventdatasjsonstringEndAt = event.data.indexOf('{');
            let eventdatajson
            if (eventdatasjsonstringStartAt >= 0) {
                console.log(event.data.substring(eventdatasjsonstringStartAt))
                eventdatajson = JSON.parse(event.data.substring(eventdatasjsonstringStartAt));
                console.log(eventdatajson);
                // update table
                const indexRow = document.getElementById("row_"+eventdatajson["index"])
            }
            if (event.data.endsWith('.')) {
                eventSource.close();
                console.log('connection is closed');
            }
        };
    }


</script>
<script>
    fetch('/api/server').then(response=> {
        console.log(response);
        return response.json();
    }).then(jsonbody=>{
        console.log(jsonbody);
        const serversArray = jsonbody.servers;
        // Get the container element where the table will be placed
        const tableContainer = document.getElementById('status-table-container');
        const table = document.createElement('table');
        table.className = "table table-hover table-bordered";
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const dynamicdataHeadersArray = ['online6', 'uptime', 'load_1', 'load_5', 'load_15', 'memory_total', 'memory_used', 'swap_total', 'swap_used', 'hdd_total', 'hdd_used', 'cpu', 'network_rx', 'network_tx', 'network_in', 'network_out', 'ip_status', 'ping_10010', 'ping_189', 'ping_10086', 'time_10010', 'time_189', 'time_10086', 'tcp', 'udp', 'process', 'thread', 'io_read', 'io_write'];
        const staticdataHeadersArray = ['name', 'type', 'host', 'location'];
        const headersArray = staticdataHeadersArray.concat(dynamicdataHeadersArray);
        headersArray.forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Generate table rows
        const tbody = document.createElement('tbody');
        for (let i = 0; i < serversArray.length; i++) {
            const row = document.createElement('tr');
            row.id = "row_"+i;
            for (let j = 0; j < headersArray.length; j++) {
                const cell = document.createElement('td');
                cell.textContent = serversArray[i][headersArray[j]];
                row.appendChild(cell);
            }
            row.addEventListener('click', function() {
                const nextRow = document.getElementById("row2_"+i);
                if (nextRow && nextRow.classList.contains('expandable')) {
                    if (nextRow.style.display === 'none' || nextRow.style.display === '') {
                        nextRow.style.display = 'table-row';
                    } else {
                        nextRow.style.display = 'none';
                    }
                }
            });
            tbody.appendChild(row);

            const row2 = document.createElement('tr');
            row2.className = "expandable";
            row2.style.display = "none";
            row2.id = "row2_"+i;

            let row2div = document.createElement('td');
            row2div.colSpan = headersArray.length;
            row2div.textContent = JSON.stringify(serversArray[i]);
            row2.appendChild(row2div);
            // for (let j = 0; j < headersArray.length; j++) {
            //     const cell = document.createElement('td');
            //     cell.textContent = serversArray[i][headersArray[j]];
            //     row2.appendChild(cell);
            // }
            tbody.appendChild(row2);
        }
        table.appendChild(tbody);

        // Append the table to the container
        tableContainer.appendChild(table);
    })

</script>
</body>
</html>