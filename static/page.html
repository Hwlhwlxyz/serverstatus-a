<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<p id="demo"></p>

<script>
    document.getElementById("demo").innerHTML =
        "The full URL of this page is:<br>" + window.location.href;

    const dynamicdataHeadersArray = ['online6', 'uptime', 'load_1', 'load_5', 'load_15', 'memory_total', 'memory_used', 'swap_total', 'swap_used', 'hdd_total', 'hdd_used', 'cpu', 'network_rx', 'network_tx', 'network_in', 'network_out', 'ip_status', 'ping_10010', 'ping_189', 'ping_10086', 'time_10010', 'time_189', 'time_10086', 'tcp', 'udp', 'process', 'thread', 'io_read', 'io_write'];
    const staticdataHeadersArray = ['name', 'type', 'host', 'location'];
    const headersArray = staticdataHeadersArray.concat(dynamicdataHeadersArray);
    const serverStatusConfig = {
        dynamicdataHeadersArray: dynamicdataHeadersArray,
        staticdataHeadersArray: staticdataHeadersArray,
        headersArray: headersArray
    }

</script>

<script>
    // import { define, html } from 'https://esm.sh/hybrids@^8';
    // let expandedDataComponent = define({
    //     tag: "expanded-data",
    //     statusData: {},
    //     content: (statusData) => html`<p>Hello ${statusData['uptime']}!</p> <p>Hello ${statusData['memory_total']}!</p>`,
    // });
</script>

<div style="margin: 10px">
    <p>table</p>
    <div id="status-table-container">
    </div>
</div>


<script type="module">
    import { define, html, store } from 'https://esm.sh/hybrids@^8';
    const ExpandedDataComponent = {
        tag: "expanded-data",
        statusData: {
            // value: {},
            get(host, lastValue) {
                // calculate the current value
                if (lastValue!=null) {
                    const value = JSON.stringify(lastValue);
                    return value;
                }
                else {
                    return {memory_total:"empty"};
                }
            },
            set(host, value, lastValue) {
                // use a value from the assertion
                const nextValue = (value);
                return nextValue;
            },
            observe(host, value, lastValue) {
                console.log(`${value} -> ${lastValue}`);
                console.log(JSON.stringify(value), lastValue)
            },
        },
        content: ({statusData}) => html`<p>Hello ${statusData['uptime']}!</p> <p>Hello ${statusData['memory_total']}!</p><p>statusData:${statusData}</p>`,
    };
    define(ExpandedDataComponent)
    const ExpandedDataComponentHtml = define.compile(ExpandedDataComponent);

    function parseStatusData(name, value) {
        return value;
    }

    if (window.EventSource == null) {
        alert('The browser does not support Server-Sent Events');
    } else {
        var eventSource = new EventSource('/api/statussse');

        eventSource.onopen = function () {
            console.log('connection is established');
        };

        eventSource.onerror = function (error) {
            console.log('connection state: ' + eventSource.readyState + ', error: ' + event);
        };

        eventSource.onmessage = function (event) {
            console.log('data:' + event.data);
            let eventdatasjsonstringStartAt = event.data.indexOf('{');
            let eventdatasjsonstringEndAt = event.data.indexOf('{');
            let eventdatajson
            if (eventdatasjsonstringStartAt >= 0) {
                console.log(event.data.substring(eventdatasjsonstringStartAt))
                eventdatajson = JSON.parse(event.data.substring(eventdatasjsonstringStartAt));
                console.log(eventdatajson);
                // update table
                const indexRow = document.getElementById("row_" + eventdatajson["index"]);
                const statusData = eventdatajson["data"];
                for (let j = 0; j < indexRow.cells.length; j++) {
                    if (j > serverStatusConfig.staticdataHeadersArray.length) {
                        const cell = indexRow.cells[j];
                        cell.textContent = parseStatusData(serverStatusConfig.headersArray[j], statusData[serverStatusConfig.headersArray[j]]);
                    }
                }
                const indexExpandDiv = document.getElementById("row_expand_div_" + eventdatajson["index"]);
                // indexExpandDiv.innerText = JSON.stringify(statusData);
                // let newElementExpandedData = new expandedDataComponent()
                const newElementExpandedData = ExpandedDataComponentHtml();
                newElementExpandedData.statusData = statusData;
                indexExpandDiv.appendChild(newElementExpandedData)
            }
            if (event.data.endsWith('.')) {
                eventSource.close();
                console.log('connection is closed');
            }
        };
    }


</script>

<expanded-data status-data='{uptime:123,memory_total:12345}'></expanded-data>
<script>
    fetch('/api/server').then(response => {
        console.log(response);
        return response.json();
    }).then(jsonbody => {
        console.log(jsonbody);
        const serversArray = jsonbody.servers;
        // Get the container element where the table will be placed
        const tableContainer = document.getElementById('status-table-container');
        const table = document.createElement('table');
        table.className = "table table-hover table-bordered";
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headersArray.forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Generate table rows
        const tbody = document.createElement('tbody');
        for (let i = 0; i < serversArray.length; i++) {
            const row = document.createElement('tr');
            row.id = "row_" + i;
            for (let j = 0; j < serverStatusConfig.headersArray.length; j++) {
                const cell = document.createElement('td');
                cell.textContent = serversArray[i][serverStatusConfig.headersArray[j]];
                row.appendChild(cell);
            }
            row.addEventListener('click', function () {
                const nextRow = document.getElementById("row_expand_" + i);
                if (nextRow && nextRow.classList.contains('expandable')) {
                    if (nextRow.style.display === 'none' || nextRow.style.display === '') {
                        nextRow.style.display = 'table-row';
                    } else {
                        nextRow.style.display = 'none';
                    }
                }
            });
            tbody.appendChild(row);

            const row_expand = document.createElement('tr');
            row_expand.className = "expandable";
            row_expand.style.display = "none";
            row_expand.id = "row_expand_" + i;

            let row_expandtd = document.createElement('td');
            row_expandtd.colSpan = headersArray.length;
            let row_expanddiv = document.createElement('div');
            row_expanddiv.innerText = JSON.stringify(serversArray[i]);
            row_expanddiv.id = "row_expand_div_"+i;
            row_expandtd.appendChild(row_expanddiv);
            row_expand.appendChild(row_expandtd);
            tbody.appendChild(row_expand);
        }
        table.appendChild(tbody);

        // Append the table to the container
        tableContainer.appendChild(table);
    })

</script>
</body>
</html>